# Validations in OpenAPI Spec

Status: Pending

Version: Alpha

Implementation Owner: TBD

## Motivation

Kubernetes has long provided tooling for generating OpenAPI Specification from its source code. OpenAPI Specification can be used to generate interactive documentation; code generation for documentation, clients, and servers; and automation of test cases.
Even though the specification generated by Kubernetes has served the purpose of interactive documentation very well, it's come short on providing foundations for automatic generations of clients and test cases mainly due to not leveraging all validation constructs offered by OpenAPI Spec.
A survey of GitHub issues and mailing-list threads suggest that historically it's been due to the following issues:
 - Reliance on third-party projects which lacked the ability to represent desired properties.
 - Time constraints in re-writing information available in the code or comments in a more formal manner.
 - OpenAPI Spec's inability to express the desired behaviour in prevalent version and lack of adaptation—and therefore tooling—for the upcoming versions with fixes.

In the absence of such building blocks, many have started using manually written wrappers which have proven to be difficult to maintain considering Kubernetes pace of development.

## Proposal

Validations requirements can be reduced to the ability to specify the range of values, enumerating literal values a type can hold, and the capacity to combine schemas. OpenAPI allows specifying many aspects of types of properties. Furthermore, OpenAPI 3.0 provides several keywords which can be used to combine schemas.

A simplified definition of `v1.Volume`, as it's defined in Kubernetes OpenAPI follows:

```json
{
  "io.k8s.kubernetes.pkg.api.v1.Volume": {
    "required": [
      "name"
    ],
    "properties": {
      "name": {
        "description": "Volume's name. Must be a DNS_LABEL and unique within the pod.",
        "type": "string"
      }
    }
  }
}
``` 

Even though the description of the property `name` specifies that the value must be a `DNS_LABEL` it uses no other OpenAPI constructs to enforce this requirement and further qualify sound values other than indicating that it must be of `type` string. An alternative definition could have been:

```json
{
  "io.k8s.kubernetes.pkg.api.v1.Volume": {
    "required": [
      "name"
    ],
    "properties": {
      "name": {
        "description": "Volume's name. Must be a DNS_LABEL and unique within the pod.",
        "type": "string",
        "maxLength": "63",
        "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
      }
    }
  }
}
```

Enums can also be used to greatly reduce the number of possible values. For example, here's a simplified definition of `v1.PodSpec`:

```json
{
  "io.k8s.kubernetes.pkg.api.v1.PodSpec": {
    "properties": {
      "restartPolicy": {
        "description": "Restart policy for all containers within the pod. One of Always, OnFailure, Never. Default to Always",
        "type": "string",
      }
    }
  }
}
```

Which could be rewritten:

```json
{
  "io.k8s.kubernetes.pkg.api.v1.PodSpec": {
    "properties": {
      "restartPolicy": {
        "description": "Restart policy for all containers within the pod. One of Always, OnFailure, Never. Default to Always",
        "type": "string",
        "enum": [
          "Always",
          "OnFailure",
          "Never"
        ],
        "default": "Always"
      }
    }
  }
}
```

Prior to OpenAPI 3.0, there was no official way to combine schemas. This new feature could be used to remedy the workaround currently present in Kubernetes named `IntOrString`, as defined below, which is used to represent the possibility that the value can be of type `int` or `string`:

```json
{
  "io.k8s.apimachinery.pkg.util.intstr.IntOrString": {
    "type": "string",
    "format": "int-or-string"
  }
}
```

The main use case of `IntOrString` is to describe ports. In Kubernetes a port can either be a number in the range of 1 to 65535 or a string conforming to `IANA_SVC_NAME`—both these types can be precisely defined. At the moment the code or test generator relying on this specification should be aware of the meaning of `int-or-string` format which isn't perfect.


## User Experience

### Use Cases

Ideal place to specify these constraints is the Go code of Kubernetes project which is already being used to generate `swagger.json`. One hint widely used in Kubernetes Go code is to suggest optionality. It is represented either using `+optional` comment in source code or `omitempty` struct tag.

Struct tags can also be used to indicate possible values of an enum. One way to encode them could be:

```Go
type PodSpec struct {
  RestartPolicy RestartPolicy `enum:"Always|OnFailure|Never" default:"Always"`
}
```

The problem with such encoding is that it's almost a duplication of:

```Go
type RestartPolicy string

const (
  RestartPolicyAlways    RestartPolicy = "Always"
  RestartPolicyOnFailure RestartPolicy = "OnFailure"
  RestartPolicyNever     RestartPolicy = "Never"
)
```

Which is not defectless. Or in the case of volume names:

```Go
type Volume struct {
  Name string `pattern:"^[a-z0-9]([-a-z0-9]*[a-z0-9])?$" maxLength:63`
}
```

Is a copy of what's already present in `k8s.io/apimachinery/pkg/util/validation` Go package.

## Implementation

After agreeing upon a way to specify these requirements with the least amount of duplication, the implementation is twofold: extending [kubernetes/kube-openapi](https://github.com/kubernetes/kube-openapi) to support these constructs and annotating Kubernetes source code with them.

### Client/Server Backwards/Forwards compatibility
Introducing these changes should have no effect on the server side. However, clients automatically generated from `swagger.json` will be affected. The work should be coordinated with [kubernetes-client/gen](https://github.com/kubernetes-client/gen).

## Alternatives considered

Manually written wrappers such as [doriordan/skuber](https://github.com/doriordan/skuber) or schema enricher wrappers like [fabric8io/kubernetes-model](https://github.com/fabric8io/kubernetes-model).
